import{a7 as _,a3 as O,L as P,au as x,av as v,aw as g,I as T,ax as b,ay as A,az as J,aA as R,aB as S}from"./entry.d8e26afa.js";import{r as L}from"./asyncData.8f2423e9.js";import U from"./ContentPreviewMode.38690b51.js";/* empty css                               */const F=(u=[],m,h)=>{const f=[...m||[]],n=[...h||[]],p=JSON.parse(JSON.stringify(u));for(const s of f)if(s.oldPath)if(n.splice(n.findIndex(r=>r.path===s.oldPath),1),f.find(r=>r.path===s.oldPath))p.push({path:s.path,parsed:s.parsed});else{const r=p.find(d=>d.path===s.oldPath);r&&(r.path=s.path,s.parsed?r.parsed=s.parsed:s.pathMeta&&["_file","_path","_id","_locale"].forEach(d=>{r.parsed[d]=s.pathMeta[d]}))}else if(s.new)p.push({path:s.path,parsed:s.parsed});else{const l=p.find(r=>r.path===s.path);l&&Object.assign(l,{path:s.path,parsed:s.parsed})}for(const s of n)p.splice(p.findIndex(l=>l.path===s.path),1);const w=new Intl.Collator(void 0,{numeric:!0});return p.sort((s,l)=>w.compare(s.path,l.path)),p},D=x(()=>JSON.parse(JSON.stringify(T()))),j=()=>{const u=_(),m=O().public.studio||{},h=D();let f;const n=P("studio-client-db",()=>null),p=P("studio-preview-db-files",()=>[]);u.hook("content:storage",e=>{n.value=e});const w=async(e,t,i=!0)=>{const a=v("previewToken",{sameSite:"none",secure:!0}),c=await e.getKeys(`${a.value}:`);await Promise.all(c.map(o=>e.removeItem(o))),await e.setItem(`${a.value}$`,JSON.stringify({ignoreBuiltContents:i})),await Promise.all(t.map(o=>{var C;return e.setItem(`${a.value}:${(C=o.parsed)==null?void 0:C._id}`,JSON.stringify(o.parsed))}))},s=e=>{const t=g(u,T);b(t,e||h),e||A(t,h)},l=e=>{var i,a,c,o;const t=(o=(c=(a=(i=u==null?void 0:u.vueApp)==null?void 0:i._context)==null?void 0:a.config)==null?void 0:c.globalProperties)==null?void 0:o.$pinceauTheme;!t||!(t!=null&&t.updateTheme)||(f||(f=JSON.parse(JSON.stringify((t==null?void 0:t.theme.value)||{}))),g(u,t.updateTheme,[e||f]))},r=async e=>{if(p.value=e.files=e.files||p.value||[],!n.value)return!1;const t=F(e.files,e.additions,e.deletions),i=t.filter(o=>!o.path.startsWith(R));await w(n.value,i,(e.files||[]).length!==0);const a=t.find(o=>o.path===S.appConfig);s(a==null?void 0:a.parsed);const c=t.find(o=>o.path===S.tokensConfig);return l(c==null?void 0:c.parsed),y(),!0},d=async()=>{const e=v("previewToken",{sameSite:"none",secure:!0});await $fetch("api/projects/preview/sync",{baseURL:m.apiURL,method:"POST",params:{token:e.value}})},k=()=>{const e=v("previewToken",{sameSite:"none",secure:!0}),t=document.createElement("div");t.id="__nuxt_preview_wrapper",document.body.appendChild(t),J(U,{previewToken:e,apiURL:m.apiURL,syncPreview:r,requestPreviewSyncAPI:d}).mount(t)},I=async e=>{var a,c;const t=v("previewToken",{sameSite:"none",secure:!0});if(!e)return null;e=e.replace(/\/$/,"");let i=await((a=n.value)==null?void 0:a.getItem(`${t.value}:${e}`));return i||(i=await((c=n.value)==null?void 0:c.getItem(e))),i},$=e=>{var i;const t=v("previewToken",{sameSite:"none",secure:!0});!n.value||n.value.setItem(`${t.value}:${(i=e.parsed)==null?void 0:i._id}`,JSON.stringify(e.parsed))},N=async e=>{var i;const t=v("previewToken",{sameSite:"none",secure:!0});await((i=n.value)==null?void 0:i.removeItem(`${t.value}:${e}`))},y=()=>{g(u,L)};return{apiURL:m.apiURL,contentStorage:n,syncPreviewFiles:w,syncPreviewAppConfig:s,syncPreviewTokensConfig:l,requestPreviewSynchronization:d,mountPreviewUI:k,findContentWithId:I,updateContent:$,removeContentWithId:N,requestRerender:y}};export{j as useStudio};
